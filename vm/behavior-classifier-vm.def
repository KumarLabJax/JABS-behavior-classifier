# build like:
#   singularity build --fakeroot behavior-classifier.sif behavior-classifier-vm.def

Bootstrap: docker
From: python:3.13-bookworm

%setup
    mkdir -p ${SINGULARITY_ROOTFS}/behavior-classifier

%files
    ../src /behavior-classifier/src
    ../tests /behavior-classifier/tests
    ../vm /behavior-classifier/vm
    ../*.* /behavior-classifier/

%runscript
    exec jabs-classify "$@"

%post
    pip install poetry
    pip install pytest
    poetry --directory=/behavior-classifier/ install
    poetry --directory=/behavior-classifier/ build
    pip install /behavior-classifier/dist/jabs_behavior_classifier-*-py3-none-any.whl

    # Run unittests to ensure build environment should work as intended
    # skip tests of GUI components that will fail since this Singularity image does not support the JABS gui
    cd /behavior-classifier/
    pytest --ignore=tests/test_search_bar_widget.py  tests

    # Cleanup
    rm -R /behavior-classifier
