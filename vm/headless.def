# build like:
#   singularity build --fakeroot behavior-classifier.sif headless.def

Bootstrap: docker
From: ghcr.io/astral-sh/uv:python3.13-bookworm

%environment
    export UV_SYSTEM_PYTHON=1
    export UV_PYTHON=/usr/local/bin/python

%setup
    mkdir -p ${SINGULARITY_ROOTFS}/behavior-classifier

%files
    ../src /behavior-classifier/src
    ../tests /behavior-classifier/tests
    ../vm /behavior-classifier/vm
    ../*.* /behavior-classifier/

%runscript
    exec jabs-classify "$@"

%post
    export UV_SYSTEM_PYTHON=1
    export UV_PYTHON=/usr/local/bin/python

    cd /behavior-classifier/
    uv sync --locked --compile-bytecode --no-editable

    # Run unittests to ensure build environment should work as intended
    # skip tests of GUI components that will fail since this Singularity image does not support the JABS gui
    uv run pytest --ignore=tests/test_search_bar_widget.py  tests

    # TODO: Decide if we want to keep this rm -R command
    # Cleanup
    # rm -R /behavior-classifier
