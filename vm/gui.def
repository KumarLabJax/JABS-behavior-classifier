# build like:
#   singularity build --fakeroot JABS-GUI.sif gui.def

Bootstrap: docker
From: ghcr.io/astral-sh/uv:python3.13-bookworm


%setup
    mkdir -p ${SINGULARITY_ROOTFS}/behavior-classifier

%files
    ../src /behavior-classifier/src
    ../tests /behavior-classifier/tests
    ../vm /behavior-classifier/vm
    ../*.* /behavior-classifier/

%runscript
    exec jabs "$@"

%post
    # GUI libraries
    apt-get update && apt-get install -y \
        qt6-base-dev \
        libglu1-mesa-dev \
        libgl1-mesa-glx \
        alsa-utils \
        libnss3 \
        libxkbfile1 \
        'libxcb*' &&
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*
    # Note that libxcb is wildcarded because it wasn't very clear which xcb library was missing, so we can just grab them all

    export UV_SYSTEM_PYTHON=1
    export UV_PYTHON=/usr/local/bin/python

    cd /behavior-classifier/
    uv sync --locked --compile-bytecode --no-editable

    # Run unittests to ensure build environment should work as intended
    uv run pytest tests

    uv build
    python3 -m pip install dist/*.whl

    # TODO: Decide if we want to keep this rm -R command
    # Cleanup
    # rm -R /behavior-classifier

